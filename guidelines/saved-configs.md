Как менять умолчания в конфигах
===============================

Проблема
--------

Время от времени бывает нужно доставить на контроллеры изменения в
конфигурационные файлы по умолчанию.

Такие изменения обычно болезненные, потому что надо учитывать много факторов:
файл сохраняется в `/mnt/data`, пользователь мог его изменить и т.д.

В Wiren Board конфигурационный файл может быть в одном из этих состояний:

 - исходное из оригинального пакета;
 - изменён только пользователем;
 - изменён нами через wb-configs и остался в /etc;
 - изменён нами через wb-configs и перенесён в /mnt/data симлинком;
 - изменён нами через wb-configs и синхронизируется с /mnt/data через inotify;
 - изменён нами, а затем пользователем (все три ситуации выше).

Изменение конфига в исходниках wb-configs приведёт к обновлению конфига
только в том случае, если пользователь не изменял файл на своём контроллере.

Ещё нужно учитывать обновление через FIT, которое вообще никак не влияет на
файлы в /mnt/data, если не сделать это явно через postinst-скрипты.


Варианты решения
----------------

Допустим, нам нужно поменять конфиг сервиса с очередным обновлением.
Как это сделать и не наступить на грабли из-за перечисленных выше ситуаций?

Чтобы упростить принятие решения, можно воспользоваться этой схемой.

 1. Проверить, есть ли условная `conf.d`-директория для пакета в `/usr`
    и можно ли туда положить фрагмент конфига. Если да - это самый лучший вариант.
    Пример - NetworkManager.
 2. Можно ли добавить аргументы или переменные окружения при запуске сервиса
    через `override` в systemd. `override`-файлы можно класть в `/lib` и
    они не будут считаться `conffile`-ами, потому это второй вариант из лучших.
    Хороший исход - подложить через `override` аргумент для загрузки второго
    конфигурационного файла из `/usr`.
 3. Проверить, есть ли условная `conf.d`-директория в `/etc`.
    Если да, то внести файл туда, дописав в комментариях, что его нельзя редактировать.
    Этот вариант чуть хуже предыдущих, потому что файлы в `/etc`
    считаются `conffile`-ами, потому не удаляются без purge и не меняются после
    редактирования пользователем. Чтобы файл не считался `conffile`, можно его
    создать из `postinst`-скрипта (например, копированием из `/usr/share`), но надо
    помнить, что удалять его тоже надо будет руками.
    Пример - dnsmasq.
 4. Можно ли добавить что-то в `/etc/default`. Сработает только в случае, если
    раньше не было соответствующего файла в `/etc/default` (если был, то
    проблема такая же, как с редактированием исходного конфига).

Если всё это не получилось устроить, вот самые плохие варианты:

 1. Поправлять конфиг sed-ом на месте, не забыть сделать это при обновлении
    через apt и фитом. Нужно учитывать, что пользователь мог поменять параметр
    под себя.
 2. Заменить конфиг целиком и писать кучу скриптов, чтобы эта подмена заезжала
    при обновлении как из пакета, так и фитом. Самый сложный способ, нужно учесть
    много деталей.

Что почитать
------------

 * [dpkg-maintscript-helper](https://manpages.debian.org/unstable/dpkg/dpkg-maintscript-helper.1.en.html) -
   как переименовать или удалить старый конфигурационный файл при обновлении пакетов
 * [file-in-etc-not-marked-as-conffile](https://lintian.debian.org/tags/file-in-etc-not-marked-as-conffile) -
   так lintian ругается на не-conffile в `/etc`
 * [Debian policy about configs](https://www.debian.org/doc/debian-policy/ch-files.html#configuration-files)
