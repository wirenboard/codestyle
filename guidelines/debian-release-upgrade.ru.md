Debian Release Upgrade
======================

Этот гайдлайн описывает процесс обновления версии Debian в новом релизе и меры
поддержки старого релиза.

По этому гайдлайну производится переход на Debian Bullseye с Debian Stretch
между релизами wb-2204 и wb-2207.


Общие проблемы при обновлении
-----------------------------

Здесь описаны общие проблемы. Иногда миграция может получиться более
болезненной (например, такой была миграция с wheezy на stretch из-за отказа от
sysv в пользу systemd).

Основные проблемы:

  * часть пакетов нужно будет собрать новым компилятором, с новыми библиотеками
    (бинарными);
  * некоторые пакеты-зависимости могут быть удалены из репозиториев Debian или
    быть deprecated (актуальный пример - python2, к которому уже не собирают
    пакеты с библиотеками);
  * может понадобиться хитрая процедура обновления всей системы, если простого
    `apt update && apt dist-upgrade` не хватает;
  * может понадобиться бэкпортировать фиксы нашего ПО для версий пакетов из
    нашего предыдущего релиза (с предыдущим дистрибутивом Debian).

О том, как решать эти проблемы, расписано далее в этом гайдлайне.


Сборка пакетов под новый дистрибутив
------------------------------------

В Wiren Board сборка пакетов производится с помощью
[devenv](https://github.com/wirenboard/wirenboard).

Начиная с релиза `stretch`, в `devenv` появилось `schroot`-окружение, которое
позволяет собирать пакеты с помощью утилиты `sbuild`. Она производит сборку
пакета в своём `chroot` (отдельном для каждого поддерживаемого релиза Debian),
при этом автоматически устанавливает пакеты-зависимости (из списка
`Build-Depends`).

Для того чтобы добавить поддержку нового дистрибутива в процедуру сборки
пакетов, нужно сделать следующее:

 1. Добавляем в devenv новое schroot-окружение (описано в файле `devenv/build.sh`
   в репозитории [wirenboard](https://github.com/wirenboard/wirenboard/)).

 2. Добавляем в `devenv/entrypoint.sh` новые таргеты. При обновлении до
    `bullseye` добавляем таргет `bullseye-armhf` (и для остальных архитектур
    или отдельных плат на той же архитектуре, если требуется). **Не меняем
    таргет для сборки по умолчанию!** (например, `current-armhf`). Это
    произойдёт позже в этой же инструкции.

 3. Добавляем название нового релиза Debian первым в список в
    [jenkins-pipeline-lib](https://github.com/wirenboard/jenkins-pipeline-lib/blob/master/vars/wb.groovy).
    Так новый релиз будет доступен для сборки, например, в пайплайне `build-image`.

 3. Замораживаем релиз `testing` для текущего дистрибутива Debian (т.е. фиксируем
    список пакетов в [wb-releases](https://github.com/wirenboard/wb-releases). Цель -
    оставить там пакеты, собранные для этого дистрибутива.

 4. Переназначаем в `devenv/entrypoint.sh` таргеты `current-*`, добавленные на шаге 2,
    на новый дистрибутив. Если в пакеты с предыдущего релиза понадобится вносить изменения,
    нужно будет в их Jenkinsfile поменять в `defaultTargets` `current` на `old_debian`
    (где `old_debian` - версия Debian, с которой мы делаем миграцию).

 5. Создаём для нового дистрибутива релиз `testing`. В самом начале миграции
    удобно собирать его как список пакетов в `wb-releases`, потому что часть пакетов
    в первое время будет работать только из веток, где вносятся модификации для
    работы в новом дистрибутиве.

 6. Проверяем и вливаем все новые пакеты.

 7. Когда все пакеты влиты, меняем в пайплайне
    [checkStaging](https://github.com/wirenboard/wirenboard/blob/master/ci/pipelines/checkStaging.groovy)
    значение по умолчанию в `DEBIAN_RELEASE` на название нового релиза.

 8. Добавляем в `releases.yaml` в секцию `staging` в `exclude`, если там ещё нет:

    ```yaml
    - package: "*wb-update-manager"
      version: "*-upgrade*"
    ```

    Это нужно, чтобы версия `wb-update-manager` со скриптами перехода не просочилась
    в новый релиз.

 9. Исключаем из нового `staging` все ненужные пакеты из старого релиза. (Пример такого пакета -
    `nginx` при переходе со `stretch` на `bullseye`: в `stretch` у нас была своя самосборная
    версия). Это можно сделать добавлением пакета в `exclude` в секции `staging` в `releases.yaml`.

 10. Заменяем фиксированный список пакета для нового релиза в `testing` на `@staging.latest`.
     Перед вливанием собираем репозиторий из ветки с флагом `PUBLISH` и проверяем, что в новом
     репозитории (будет доступен как `deb.wirenboard.com/git/<your/branch/name>/wbX/<new_debian>`)
     не оказалось лишних пакетов (в частности, исключённых из `staging`,
     а также переходной версии `wb-update-manager`). Вливаем PR.

 11. Проверяем, что пайплайн `check-staging` корректно собирает образы с новым релизом Debian.

 12. Заменяем в `releases.yaml` для нового релиза `@staging.latest` на `@unstable.latest`.

 13. Когда релиз готов к переходу в стабильную фазу, замораживаем список пакетов, как обычно.
     Не забываем убедиться, что вместе со стабильным релизом на новой версии Debian в `stable`
     старой версии въедет пакет со скриптами для перехода.


Разрешение сломанных зависимостей
---------------------------------

Самый правильный способ разрешения сломанных зависимостей - переход на
обновлённые версии из нового дистрибутива. Это может потребовать изменения
кода, разумеется.

Такой способ безопасно работает после заморозки `testing` для старого
дистрибутива, т.к. новые пакеты туда автоматически уже не попадут.

Это самый предпочтительный сценарий.

В редких случаях может получиться так, что пакет-зависимость из нового
дистрибутива удалён, а поменять его мы ни на что не можем (очень старый софт,
или библиотека какая специфичная). В этом случае есть два пути решения:

 1. Осознанное решение выкинуть старый пакет (возможно, он уже просто никому не
    нужен). Так мы в своё время поступили с поддержкой модулей RFM69.

 2. Перенос пакетов-зависимостей. В этом случае нужно проверить, что пакет из
    репозитория прошлого дистрибутива нормально установится в новый (и
    зависимости разрешатся как надо), после чего пакет надо вручную добавить в
    пул и добавить в релизный список.


Хитрая процедура обновления
---------------------------

Специально для реализации хитрых процедур обновления существует пакет
`wb-update-manager` и соответствующая утилита `wb-release`.

В эту утилиту можно добавить код, который правильным образом произведёт
обновление системы.

Процедура обновления системы должна запускаться по флагу `--update-debian-release`.
Она не должна переключать текущий релиз у пользователя! Был `stable` - должен `stable`
и остаться.

Таким образом, путь внедрения хитрой процедуры обновления таков:

 1. Делаем ветку от того состояния `wb-release`, которое было доступно в
    `testing` старого дистрибутива на момент заморозки, называем ветку
    `release/<new debian>-upgrade` (например, `release/bullseye-upgrade` для
    перехода на `bullseye`).

 2. Первую версию кода для перехода можно взять из `release/bullseye-upgrade`,
    там уже учтены некоторые тонкости. Часть процессов (например, избавление
    от `python2`), скорее всего, в новом переходе не понадобится.

 2. Добавляем нужный код, убеждаемся, что он работает по флагу `--update-debian-release`.

 3. Создаём PR, название этой версии должно выглядеть так. Пусть старый релиз
    Debian имеет номер версии 9, версия утилиты в testing - `1.2.3`.
    Версия пакета получается такой: `1.2.3-upgradeX`. При внесении правок
    в процедуру обновления увеличиваем последнюю цифру `1.2.3-upgrade2`.

 6. Вливаем PR, добавляем новый wb-update-manager в релизный список.

Аналогичные действия стоит проделать с пакетом `wb-mqtt-homeui`, туда мы
добавляли убираемый баннер с напоминанием о том, что можно перейти на новую
версию debian
(взять можно [отсюда](https://github.com/wirenboard/homeui/tree/release/bullseye-upgrade)).

После выполнения этапа 6, у нынешних пользователей `testing` появится
возможность обновиться до нового релиза Debian, а после выхода нового релиза
это автоматически будет доставлено до пользователей `stable`.

Автоматического обновления (которое потенциально может сломать пользователям
систему) произойти при этом не должно.


Бэкпортирование в старый дистрибутив
------------------------------------

Когда требуется перенести изменения в пакет в предыдущий релиз (на предыдущем
дистрибутиве Debian), работает стандартная процедура бэкпорта, с такими
поправками:

 - В Jenkinsfile в релизной ветке нужно прописать `defaultTarget`,
   соответствующий предыдущему релизу: вместо `wb6` или `current-armhf` вписать
   `stretch-armhf`.
