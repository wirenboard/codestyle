Требования к организации настроек сервисов
======

Настройки сервисов
----

1. Настройки сервисов хранить в `/etc/ИМЯ_СЕРВИСА.conf` в формате JSON.

2. Дополнительные настройки, которые представляют собой отдельные файлы, хранить в каталоге `/etc/ИМЯ_СЕРВИСА.conf.d/`.

3. Корректность структуры и содержания файла настроек проверять через JSON-валидатор. Для этого использовать JSON-схему. Это позволит сразу получить интерфейс для редактирования файла в `wb-mqtt-homeui/wb-mqtt-confed` и избавит от сложного кода проверки корректности в сервисе. В `libwbmqtt1` для этого есть `JSON::Validate`.

4. Часть настроек можно сделать недоступными для редактирования пользователем. Например, когда какие-то параметры определяются аппаратными характеристиками. Для этого надо использовать каталог `/var/lib/ИМЯ_СЕРВИСА/conf.d`. В нём располагать файлы, содержащие настройки, сгенерированные в процессе работы, и содержащие параметры, недоступные для редактирования. Финальный набор настроек в этом случае будет представлять собой слияние файлов из `/var/lib/.../conf.d` и `/etc`. Для слияния настроек можно использовать функцию `JSON::Merge`, она позволяет задать правила слияния, указать какие параметры нельзя изменять и по какому признаку объединять элементы массивов.

5. Файлы в `/var/lib` должны быть генерируемыми. Если нужны какие-то части конфигурации, которые приезжают с пакетами в готовом виде, но не должны редактироваться, надо хранить их в `/usr/share`.

6. Файлы в `/var/lib/.../conf.d` должны быть одинакового формата между собой и со всеми остальными файлами настроек сервиса и уметь сливаться через `JSON::Merge` в один конфиг без привязки к именам файлов. Например, нельзя сделать два файла `one.conf` и `two.conf`, которые бы разбирались по-разному.

GUI для редактирования настроек
----

1. Для редактирования файлов настроек используются `wb-mqtt-homeui` (SPA с веб-интерфейсом) и `wb-mqtt-confed` (бакэнд, который передаёт файлы настроек через MQTT RPC и сохраняет их в системе).

2. Сервис, редактирование файлов настроек которого надо реализовать через wb-mqtt-confed, должен разместить схему настроек в `/usr/share/wb-mqtt-confed/schemas`, если структура файла настроек статическая, или в `/var/lib/wb-mqtt-confed/schemas`, если структура файла настроек может изменяться, и схема генерируется сервисом в процессе работы.

3. Для редактирования файлов настроек в `wb-mqtt-homeui` используется [json-editor](https://github.com/json-editor/json-editor). Он поддерживает дополнительные параметры в схеме для организации GUI.

4. Схема должна содержать переводы строк, которые отображаются в `wb-mqtt-homeui`, на русский язык. Они описываются в параметре `translations`. Там же можно указать длинные английские строки.


Альтернативные файлы настроек
----

По умолчанию сервис должен уметь запускаться без флагов вообще, при этом он читает файл настроек из `/etc/ИМЯ_СЕРВИСА.conf`. Для запуска с альтернативным файлом настроек использовать флаг `-c` и путь до этого файла.